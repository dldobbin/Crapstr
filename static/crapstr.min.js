$(document).ready(function(){function f(){b=new google.maps.LatLng(41.8762686,-87.6322661),navigator.geolocation?navigator.geolocation.getCurrentPosition(function(a){b=new google.maps.LatLng(a.coords.latitude,a.coords.longitude),g()},function(){g()}):g()}function g(){var c={zoom:15,center:b,clickableIcons:!1,mapTypeControl:!1};a=new google.maps.Map(document.getElementById("map-canvas"),c);var d=$('<div class="control" style="zIndex: 1;"><img src="static/graylet.png" /></div>');d.click(function(){d.hasClass("selected")||($(".selected").removeClass("selected"),d.addClass("selected"),k(),h(),a.controls[google.maps.ControlPosition.TOP_CENTER].pop())});var f=$('<div class="control" style="zIndex: 1;"><img src="static/graylet.png" /></div>');f.click(function(){f.hasClass("selected")||($(".selected").removeClass("selected"),f.addClass("selected"),k(),e||(e=$('<div class="control"><form><input type="text" /><input type="submit" value="Search" /></form></div>'),e.children().submit(function(b){b.preventDefault(),k();var c=new google.maps.places.PlacesService(a),d={location:a.getCenter(),radius:5e3,keyword:$(this).children("input[type=text]")[0].value};c.radarSearch(d,function(a,b){b==google.maps.places.PlacesServiceStatus.OK&&a.forEach(function(a){i(a.geometry.location,a.place_id)})})})),a.controls[google.maps.ControlPosition.TOP_CENTER].push(e[0]),e.find("input[type=text]").focus())}),a.controls[google.maps.ControlPosition.TOP_RIGHT].push(f[0]),a.controls[google.maps.ControlPosition.TOP_RIGHT].push(d[0]),d.click()}function h(){$.ajax({url:"/location",dataType:"json",data:{lat:a.getCenter().lat(),lon:a.getCenter().lng()}}).done(function(a){a.forEach(function(a){i(new google.maps.LatLng(a.lat,a.lon),a.placeId)})})}function i(b,e){var f=new google.maps.Marker({position:b,icon:"static/graylet.png",map:a});c.push(f),google.maps.event.addListener(f,"click",function(){j(b,e,function(){d.open(a,f)})})}function j(a,b,c){$.ajax({url:"/reviews/"+b,dataType:"json"}).done(function(e){var f="",g=!1;e.reviews.length?(e.reviews.forEach(function(a){f+="<hr><div><p class='rating star-"+a.rating+"'/><p><b>Description</b>: "+a.description+"</p></div>"}),f="<div><p class='rating star-"+String(e.avg).replace(".","-")+"'/></div>"+f):(f="No reviews yet! Be the first to review this terlet!",g=!0),f=$("<div class='infowindow_container'>"+f+"<div class='button'>Add Review</div></div>"),f.children(".button").click(function(){l(f[0],g,a,b)}),d.setContent(f[0]),c()})}function k(){c.forEach(function(a){a.setMap(null)}),c=[]}function l(a,b,c,e){var f=$("<div class='infowindow_container'><div class='rating star-0'><div></div><div></div><div></div><div></div><div></div></div><p><b>Description</b>: <input type='text' /></p><div class='cancel button'>Cancel</div><div class='submit button'>Submit</div></div>"),g=0;f.find(".rating div").mouseover(function(){f.children(".rating").removeClass().addClass("rating star-"+String($(this).index()+1))}),f.find(".rating div").mouseout(function(){f.children(".rating").removeClass().addClass("rating star-"+g)}),f.find(".rating div").click(function(){g=$(this).index()+1}),f.find(".cancel").click(function(){d.setContent(a)}),f.find(".submit").click(function(){b?$.ajax({url:"/location",method:"post",data:{placeId:e,lon:c.lng(),lat:c.lat(),description:f.find("input[type=text]")[0].value,rating:g}}).done(function(){j(c,e,function(){})}):$.ajax({url:"/reviews",method:"post",data:{placeId:e,description:f.find("input[type=text]")[0].value,rating:g}}).done(function(){j(c,e,function(){})})}),d.setContent(f[0])}var a,b,e,c=[],d=new google.maps.InfoWindow;google.maps.event.addDomListener(window,"load",f)});